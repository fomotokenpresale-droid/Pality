<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wallet UI</title>

    <style>
        body {
            margin: 0;
            font-family: Arial, sans-serif;
            background: #f6f7fb;
            color: #1a1a1a;
        }

        .page {
            display: none;
            padding: 15px;
        }

        .header {
            padding: 20px;
            text-align: center;
            background: white;
            font-size: 22px;
            font-weight: bold;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .balance-card {
            background: linear-gradient(145deg, #0e3a2b, #1e6f55);
            padding: 20px;
            margin: 15px;
            border-radius: 18px;
            color: white;
            box-shadow: 0 4px 10px rgba(0,0,0,0.15);
        }

        .balance-card h2 {
            margin: 0;
            font-size: 15px;
            opacity: 0.9;
        }

        .balance-card .amount {
            font-size: 32px;
            font-weight: bold;
            margin-top: 8px;
        }

        .section-title {
            margin: 20px 15px 10px;
            font-size: 18px;
            font-weight: bold;
        }

        .coin {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 14px;
            background: white;
            margin: 12px 15px;
            border-radius: 14px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.08);
            cursor: pointer;
        }

        .coin-left {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .coin-left img {
            width: 32px;
            height: 32px;
        }

        .coin-title {
            font-size: 15px;
            font-weight: bold;
        }

        .coin-sub {
            font-size: 13px;
            opacity: 0.7;
            margin-top: 2px;
        }

        /* ------------------------------------------
           ALIGNED COIN BALENCES (your request)
           ------------------------------------------ */
        .coin-balance {
            display: flex;
            flex-direction: column;
            text-align: right;
            min-width: 120px;
            line-height: 1.2;
        }

        .coin-amount {
            font-size: 14px;
            font-weight: bold;
        }

        .coin-usd {
            font-size: 12px;
            opacity: 0.7;
            margin-top: 2px;
        }

        /* BUTTONS, MODALS, POPUPS, SEND SCREEN, etc.
           (keeping your original styles exactly intact)
        */

        .action-btn {
            background: #0a53ff;
            color: white;
            border: none;
            padding: 14px;
            width: 100%;
            font-size: 16px;
            border-radius: 12px;
            margin-top: 20px;
        }

        .ghost-btn {
            background: white;
            border: 1px solid #ccc;
            padding: 12px;
            border-radius: 10px;
            width: 100%;
            font-size: 15px;
        }

        .send-box {
            background: white;
            margin-top: 12px;
            padding: 14px;
            border-radius: 14px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
        }

        .send-input {
            width: 100%;
            border: none;
            outline: none;
            padding: 8px 0;
            font-size: 16px;
        }

        .spinner {
            width: 45px;
            height: 45px;
            border: 4px solid #ccc;
            border-top-color: #0a53ff;
            border-radius: 50%;
            animation: spin 0.9s linear infinite;
            margin: auto;
            margin-top: 25px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .processing-card {
            background: white;
            padding: 25px;
            border-radius: 16px;
            text-align: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.15);
            max-width: 330px;
            margin: auto;
        }

        .processing-title {
            font-size: 20px;
            margin-top: 18px;
            font-weight: bold;
        }

        .processing-text {
            font-size: 14px;
            opacity: 0.7;
            margin-top: 6px;
        }

        .status-success {
            background: #c9f7d8;
            padding: 6px 14px;
            border-radius: 20px;
            color: #0a7a30;
            font-size: 14px;
            font-weight: bold;
        }

        .status-pending {
            background: #fff3c4;
            padding: 6px 14px;
            border-radius: 20px;
            color: #b17d00;
            font-size: 14px;
            font-weight: bold;
        }
    </style>
</head>
<body>

    <!-- HOME PAGE -->
    <div id="home-page" class="page" style="display:block;">

        <div class="header">Wallet</div>

        <div class="balance-card">
            <h2>Total Balance</h2>
            <div id="mainBalance" class="amount">$0.00</div>
        </div>

        <div class="section-title">Coins</div>

        <!-- BTC -->
        <div class="coin" id="btcRow">
            <div class="coin-left">
                <img src="images/btc.png">
                <div>
                    <div class="coin-title">Bitcoin</div>
                    <div class="coin-sub">Live</div>
                </div>
            </div>

            <div class="coin-balance">
                <div class="coin-amount" id="btcWalletBalance">0 BTC</div>
                <div class="coin-usd">($0.00)</div>
            </div>
        </div>

        <!-- SOL -->
        <div class="coin" id="solRow">
            <div class="coin-left">
                <img src="images/sol.png">
                <div>
                    <div class="coin-title">Solana</div>
                    <div class="coin-sub">Live</div>
                </div>
            </div>

            <div class="coin-balance">
                <div class="coin-amount" id="solWalletBalance">0 SOL</div>
                <div class="coin-usd">($0.00)</div>
            </div>
        </div>

        <!-- ETH -->
        <div class="coin" id="ethRow">
            <div class="coin-left">
                <img src="images/eth.png">
                <div>
                    <div class="coin-title">Ethereum</div>
                    <div class="coin-sub">Live</div>
                </div>
            </div>

            <div class="coin-balance">
                <div class="coin-amount" id="ethWalletBalance">0 ETH</div>
                <div class="coin-usd">($0.00)</div>
            </div>
        </div>

        <!-- BNB -->
        <div class="coin" id="bnbRow">
            <div class="coin-left">
                <img src="images/bnb.png">
                <div>
                    <div class="coin-title">BNB</div>
                    <div class="coin-sub">Live</div>
                </div>
            </div>

            <div class="coin-balance">
                <div class="coin-amount" id="bnbWalletBalance">0 BNB</div>
                <div class="coin-usd">($0.00)</div>
            </div>
        </div>

        <!-- MATIC -->
        <div class="coin" id="maticRow">
            <div class="coin-left">
                <img src="images/matic.png">
                <div>
                    <div class="coin-title">Polygon</div>
                    <div class="coin-sub">Live</div>
                </div>
            </div>

            <div class="coin-balance">
                <div class="coin-amount" id="maticWalletBalance">0 MATIC</div>
                <div class="coin-usd">($0.00)</div>
            </div>
        </div>

    </div>
    <!-- BTC PAGE -->
    <div id="btcPage" class="page">

        <div style="display:flex;align-items:center;gap:10px;">
            <div id="backBtn" style="font-size:22px;cursor:pointer;">←</div>
            <div style="font-size:20px;font-weight:bold;">Bitcoin</div>
        </div>

        <div class="balance-card" style="margin-top:20px;">
            <h2>Holdings</h2>
            <div style="font-size:26px;font-weight:bold;" id="btcHoldings">0 BTC</div>
            <div style="opacity:0.7;" id="btcHoldingsFiat">$0.00</div>
        </div>

        <div class="section-title">Price</div>
        <div class="coin" style="cursor:auto;">
            <div class="coin-left">
                <img src="images/btc.png">
                <div>
                    <div class="coin-title">Bitcoin</div>
                    <div class="coin-sub" id="btcPriceText">$0.00 (Live)</div>
                </div>
            </div>

            <div class="coin-balance">
                <div class="coin-amount" id="btcPriceDetail">$0.00</div>
                <div class="coin-usd">(24h)</div>
            </div>
        </div>

        <button id="sendFromBTC" class="action-btn" style="margin-top:25px;">Send</button>

    </div>
    <!-- SEND PAGE -->
    <div id="sendBTC" class="page" aria-hidden="true">

        <div style="display:flex;justify-content:space-between;align-items:center;">
            <h2 id="sendHeader" style="margin:0;">Send</h2>
            <div id="closeSend" style="font-size:24px;cursor:pointer;" aria-label="Close send">✕</div>
        </div>

        <!-- Select coin (locked dynamically when opened) -->
        <select id="sendCoinSelect" class="select-coin" aria-label="Select coin to send">
            <option value="BTC">BTC</option>
            <option value="ETH">ETH</option>
            <option value="SOL">SOL</option>
            <option value="BNB">BNB</option>
            <option value="MATIC">MATIC</option>
        </select>

        <div style="margin-top:15px;">
            <label>Address or Domain Name</label>
            <input id="sendAddress" type="text" placeholder="Search or Enter" class="input" />
        </div>

        <div style="margin-top:15px;">
            <label>Amount</label>
            <input id="sendAmount" type="text" placeholder="Amount" class="input" />
            <div id="sendAmountFiat" style="color:#777;margin-top:5px;">≈ $0.00</div>
        </div>

        <button id="nextBtn"
            style="margin-top:30px;width:100%;padding:16px;font-size:17px;border:none;background:#e5e6eb;border-radius:14px;color:#777;"
            disabled>
            Next
        </button>

    </div>
    <!-- CONFIRM PAGE -->
    <div id="confirmSend" class="page" aria-hidden="true">

        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
            <div id="backToSend" style="font-size:22px;cursor:pointer;">←</div>
            <h2 id="confirmTitle" style="margin:0;font-weight:600;">Transfer</h2>
            <div></div>
        </div>

        <div id="confirmAmount"
             style="font-size:26px;font-weight:700;text-align:center;">0</div>

        <div id="confirmFiat"
             style="color:#666;text-align:center;margin-bottom:25px;">$0.00</div>

        <div style="background:#f3f3f3;border-radius:14px;padding:18px;margin-bottom:20px;">
            <div style="display:flex;justify-content:space-between;margin-bottom:10px;">
                <span>Asset</span><span id="confirmAssetLabel">—</span>
            </div>
            <div style="display:flex;justify-content:space-between;margin-bottom:10px;">
                <span>Wallet</span><span>Main Wallet</span>
            </div>
            <div style="display:flex;justify-content:space-between;">
                <span>To</span><span id="confirmTo">Address</span>
            </div>
        </div>

        <div style="background:#f3f3f3;border-radius:14px;padding:18px;margin-bottom:30px;">
            <div style="display:flex;justify-content:space-between;margin-bottom:10px;">
                <span>Network fee</span><span id="confirmFee">0</span>
            </div>
            <div style="display:flex;justify-content:space-between;font-weight:600;">
                <span>Max Total</span><span id="confirmTotal">$0.00</span>
            </div>
        </div>

        <button id="confirmBtn" class="action-btn">Confirm</button>

    </div>
    <!-- PROCESSING POPUP -->
    <div id="processingPopup" class="page" aria-hidden="true"
         style="position: fixed; inset: 0; background: rgba(0,0,0,0.5); display:none;
                justify-content: center; align-items: center; z-index: 1000000;">

        <div class="processing-card"
             style="background: #fff; padding: 24px; border-radius: 14px; width: calc(100% - 64px);
                    max-width: 360px; text-align: center;">

            <div class="spinner"
                 style="width: 56px; height: 56px; border-radius: 50%;
                        border: 6px solid #e6e6e6; border-top-color: #0a53ff;
                        margin: 0 auto 14px; animation: spin 1s linear infinite;"
                 aria-hidden="true"></div>

            <div class="processing-title" style="font-weight:700;margin-bottom:8px;">
                Processing
            </div>

            <div class="processing-text" style="color:#555;font-size:14px;">
                Transaction in progress! Blockchain validation is underway...
            </div>

            <div class="processing-actions">
                <button id="processingDetails" class="ghost-btn">Transaction Details</button>
            </div>

        </div>
    </div>


    <!-- SUCCESS SCREEN -->
    <div id="success-screen" class="page" aria-hidden="true" style="padding:20px; display:none;">

        <div style="text-align:center;">

            <div style="font-size:48px; margin-bottom:10px;">✅</div>

            <div style="font-weight:700;font-size:20px;margin-bottom:8px;">
                Transaction Successful
            </div>

            <div id="success-sub" style="color:#666;margin-bottom:20px;">
                Your transaction has been processed.
            </div>

            <button id="view-details" class="ghost-btn">View Details</button>

            <button id="success-done" class="action-btn">Done</button>

        </div>

    </div>
    <!-- TX DETAILS PAGE -->
    <div id="txDetails" class="page" style="display:none; padding:20px;">

        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:18px;">
            <div id="txBack" style="cursor:pointer;font-weight:700;">◀ Back</div>
            <div id="txStatus" class="status-pending" style="color:#f59e0b;font-weight:700;">Pending</div>
        </div>

        <div id="txAmount"
             style="font-size:20px;font-weight:700;margin-bottom:8px;">0</div>

        <div id="txFiat"
             style="color:#666;margin-bottom:16px;">$0.00</div>

        <div style="background:#f3f3f3;border-radius:12px;padding:12px;margin-bottom:12px;">

            <div class="tx-row" style="display:flex;justify-content:space-between;margin-bottom:10px;">
                <span>To</span><span id="txTo">Address</span>
            </div>

            <div class="tx-row" style="display:flex;justify-content:space-between;margin-bottom:10px;">
                <span>Fee</span><span id="txFee">0</span>
            </div>

            <div class="tx-row" style="display:flex;justify-content:space-between;margin-bottom:10px;">
                <span>Total</span><span id="txTotal">$0.00</span>
            </div>

            <div class="tx-row" style="display:flex;justify-content:space-between;">
                <span>Timestamp</span><span id="txTime">-</span>
            </div>

        </div>

        <button id="txDone" class="action-btn">Done</button>

    </div>
<script>
/* ======================================================
   MASTER PORTFOLIO + CONFIG
   ====================================================== */

const portfolio = {
  BTC: { amount: 0.67, api: 'bitcoin', price: 0, usd: 0 },
  SOL: { amount: 104, api: 'solana', price: 0, usd: 0 },
  ETH: { amount: 19, api: 'ethereum', price: 0, usd: 0 },
  BNB: { amount: 249, api: 'binancecoin', price: 0, usd: 0 },
  MATIC: { amount: 834, api: 'matic-network', price: 0, usd: 0 }
};

const displayConfig = {
  BTC: {decimals:8},
  ETH: {decimals:6},
  SOL: {decimals:4},
  BNB: {decimals:4},
  MATIC: {decimals:2}
};

/* ======================================================
   ELEMENT SELECTORS (grab all needed DOM nodes once)
   ====================================================== */

const mainBalanceEl = document.getElementById('mainBalance');

const btcRow = document.getElementById('btcRow');
const solRow = document.getElementById('solRow');
const ethRow = document.getElementById('ethRow');
const bnbRow = document.getElementById('bnbRow');
const maticRow = document.getElementById('maticRow');

const btcWalletBalanceEl = document.getElementById('btcWalletBalance');
const solWalletBalanceEl = document.getElementById('solWalletBalance');
const ethWalletBalanceEl = document.getElementById('ethWalletBalance');
const bnbWalletBalanceEl = document.getElementById('bnbWalletBalance');
const maticWalletBalanceEl = document.getElementById('maticWalletBalance');

const btcHoldingsEl = document.getElementById('btcHoldings');
const btcHoldingsFiatEl = document.getElementById('btcHoldingsFiat');

const btcPriceTextEl = document.getElementById('btcPriceText');
const btcPriceDetailEl = document.getElementById('btcPriceDetail');
const solPriceTextEl = document.getElementById('solPriceText');
const ethPriceTextEl = document.getElementById('ethPriceText');
const bnbPriceTextEl = document.getElementById('bnbPriceText');
const maticPriceTextEl = document.getElementById('maticPriceText');

const btcPage = document.getElementById('btcPage');
const sendBTC = document.getElementById('sendBTC');
const confirmSend = document.getElementById('confirmSend');
const processingPopup = document.getElementById('processingPopup');
const txDetails = document.getElementById('txDetails');
const successScreen = document.getElementById('success-screen');

const sendHeader = document.getElementById('sendHeader');
const sendCoinSelect = document.getElementById('sendCoinSelect');
const sendAddressEl = document.getElementById('sendAddress');
const sendAmountEl = document.getElementById('sendAmount');
const sendAmountFiatEl = document.getElementById('sendAmountFiat');
const nextBtn = document.getElementById('nextBtn');

const backBtn = document.getElementById('backBtn');
const sendFromBTC = document.getElementById('sendFromBTC');
const closeSend = document.getElementById('closeSend');
const backToSend = document.getElementById('backToSend');
const confirmBtn = document.getElementById('confirmBtn');

const processingDetails = document.getElementById('processingDetails');

const txBack = document.getElementById('txBack');
const txStatus = document.getElementById('txStatus');
const txAmount = document.getElementById('txAmount');
const txFiat = document.getElementById('txFiat');
const txTo = document.getElementById('txTo');
const txFee = document.getElementById('txFee');
const txTotal = document.getElementById('txTotal');
const txTime = document.getElementById('txTime');
const txDone = document.getElementById('txDone');

const viewDetailsBtn = document.getElementById('view-details');
const successDoneBtn = document.getElementById('success-done');

/* ======================================================
   UTILS: hide/show pages cleanly
   ====================================================== */
function hideAllPages() {
  const pages = document.querySelectorAll('.page');
  pages.forEach(p => p.style.display = 'none');
}
function showMain() {
  hideAllPages();
  document.getElementById('home-page').style.display = 'block';
}
function showSuccessScreen() {
  hideAllPages();
  successScreen.style.display = 'block';
}

/* ======================================================
   UI UPDATE: calculate USD totals and push to DOM
   ====================================================== */
function updateAllBalances() {
  let totalUSD = 0;
  for (const sym in portfolio) {
    const p = portfolio[sym];
    p.usd = (p.amount || 0) * (p.price || 0);
    totalUSD += p.usd;
  }

  if (mainBalanceEl) mainBalanceEl.innerText = `$${totalUSD.toLocaleString(undefined,{minimumFractionDigits:2, maximumFractionDigits:2})}`;

  // BTC
  const btc = portfolio.BTC;
  if (btcWalletBalanceEl) btcWalletBalanceEl.innerText = `${btc.amount.toFixed(displayConfig.BTC.decimals)} BTC`;
  if (btcHoldingsEl) btcHoldingsEl.innerText = `${btc.amount.toFixed(displayConfig.BTC.decimals)} BTC`;
  if (btcHoldingsFiatEl) btcHoldingsFiatEl.innerText = `≈ $${btc.usd.toFixed(2)}`;

  // SOL
  const sol = portfolio.SOL;
  if (solWalletBalanceEl) solWalletBalanceEl.innerText = `${sol.amount.toFixed(displayConfig.SOL.decimals)} SOL`;

  // ETH
  const eth = portfolio.ETH;
  if (ethWalletBalanceEl) ethWalletBalanceEl.innerText = `${eth.amount.toFixed(displayConfig.ETH.decimals)} ETH`;

  // BNB
  const bnb = portfolio.BNB;
  if (bnbWalletBalanceEl) bnbWalletBalanceEl.innerText = `${bnb.amount.toFixed(displayConfig.BNB.decimals)} BNB`;

  // MATIC
  const matic = portfolio.MATIC;
  if (maticWalletBalanceEl) maticWalletBalanceEl.innerText = `${matic.amount.toFixed(displayConfig.MATIC.decimals)} MATIC`;

  // Additionally update USD sub elements if present (they are static placeholders in HTML; dynamic USD shown in other places)
  const usdEls = {
    BTC: document.querySelector('#btcRow .coin-usd'),
    SOL: document.querySelector('#solRow .coin-usd'),
    ETH: document.querySelector('#ethRow .coin-usd'),
    BNB: document.querySelector('#bnbRow .coin-usd'),
    MATIC: document.querySelector('#maticRow .coin-usd')
  };
  if (usdEls.BTC) usdEls.BTC.innerText = `($${btc.usd.toLocaleString(undefined,{minimumFractionDigits:2})})`;
  if (usdEls.SOL) usdEls.SOL.innerText = `($${sol.usd.toLocaleString(undefined,{minimumFractionDigits:2})})`;
  if (usdEls.ETH) usdEls.ETH.innerText = `($${eth.usd.toLocaleString(undefined,{minimumFractionDigits:2})})`;
  if (usdEls.BNB) usdEls.BNB.innerText = `($${bnb.usd.toLocaleString(undefined,{minimumFractionDigits:2})})`;
  if (usdEls.MATIC) usdEls.MATIC.innerText = `($${matic.usd.toLocaleString(undefined,{minimumFractionDigits:2})})`;
}

/* ======================================================
   PRICE FETCHING
   ====================================================== */
async function fetchAllPrices() {
  try {
    const ids = Object.values(portfolio).map(c => c.api).join(',');
    const url = `https://api.coingecko.com/api/v3/simple/price?ids=${ids}&vs_currencies=usd`;
    const res = await fetch(url);
    const data = await res.json();

    for (const sym in portfolio) {
      const apiName = portfolio[sym].api;
      const price = data && data[apiName] && data[apiName].usd ? data[apiName].usd : 0;
      portfolio[sym].price = price;
    }

    // update price labels
    if (btcPriceTextEl) btcPriceTextEl.innerText = `$${portfolio.BTC.price.toLocaleString()} (Live)`;
    if (btcPriceDetailEl) btcPriceDetailEl.innerText = `$${portfolio.BTC.price.toLocaleString()}`;
    if (solPriceTextEl) solPriceTextEl.innerText = `$${portfolio.SOL.price.toLocaleString()} (Live)`;
    if (ethPriceTextEl) ethPriceTextEl.innerText = `$${portfolio.ETH.price.toLocaleString()} (Live)`;
    if (bnbPriceTextEl) bnbPriceTextEl.innerText = `$${portfolio.BNB.price.toLocaleString()} (Live)`;
    if (maticPriceTextEl) maticPriceTextEl.innerText = `$${portfolio.MATIC.price.toLocaleString()} (Live)`;

    updateAllBalances();
  } catch (e) {
    console.error('Price fetch failed', e);
  }
}

/* initial fetch + periodic refresh */
fetchAllPrices();
setInterval(fetchAllPrices, 10000);

/* ======================================================
   NAVIGATION & EVENTS (single-page behavior)
   ====================================================== */

/* show BTC page */
if (btcRow) btcRow.addEventListener('click', () => {
  hideAllPages();
  if (btcPage) btcPage.style.display = 'block';
});

/* show send modal from BTC page */
if (sendFromBTC) sendFromBTC.addEventListener('click', () => openSendFor('BTC'));

/* clicking coin rows opens send modal for that coin */
if (solRow) solRow.addEventListener('click', () => openSendFor('SOL'));
if (ethRow) ethRow.addEventListener('click', () => openSendFor('ETH'));
if (bnbRow) bnbRow.addEventListener('click', () => openSendFor('BNB'));
if (maticRow) maticRow.addEventListener('click', () => openSendFor('MATIC'));

/* close send modal */
if (closeSend) closeSend.addEventListener('click', () => {
  showMain();
});

/* tx details back/done */
if (txBack) txBack.addEventListener('click', () => {
  showMain();
});
if (txDone) txDone.addEventListener('click', () => {
  showMain();
});

/* back button inside btc page */
if (backBtn) backBtn.addEventListener('click', () => showMain());

/* ======================================================
   GENERIC SEND FLOW (complete) - with locked dropdown on open
   ====================================================== */

let selectedCoin = 'BTC'; // default

const coinNames = {
  BTC: "Bitcoin",
  ETH: "Ethereum",
  SOL: "Solana",
  BNB: "BNB",
  MATIC: "Polygon (MATIC)"
};

function openSendFor(symbol) {
  selectedCoin = symbol || (sendCoinSelect && sendCoinSelect.value) || 'BTC';

  // lock dropdown to single option for the selected coin
  if (sendCoinSelect) {
    sendCoinSelect.innerHTML = `<option value="${selectedCoin}">${coinNames[selectedCoin] || selectedCoin}</option>`;
    sendCoinSelect.value = selectedCoin;
  }

  if (sendHeader) sendHeader.innerText = `Send ${selectedCoin}`;

  // show send modal (page)
  hideAllPages();
  if (sendBTC) sendBTC.style.display = 'flex';

  // reset fields
  if (sendAddressEl) sendAddressEl.value = '';
  if (sendAmountEl) sendAmountEl.value = '';
  if (sendAmountFiatEl) sendAmountFiatEl.innerText = '≈ $0.00';

  // reset next button
  if (nextBtn) {
    nextBtn.style.background = '#e5e6eb';
    nextBtn.style.color = '#777';
    nextBtn.disabled = true;
  }
}

/* when changing coin selection (should be locked, but still handle) */
if (sendCoinSelect) sendCoinSelect.addEventListener('change', (e) => {
  selectedCoin = e.target.value;
  if (sendHeader) sendHeader.innerText = `Send ${selectedCoin}`;
  const val = parseFloat(sendAmountEl.value) || 0;
  if (sendAmountFiatEl) sendAmountFiatEl.innerText = `≈ $${(val * (portfolio[selectedCoin].price || 0)).toFixed(2)}`;
});

/* update fiat preview on amount input */
if (sendAmountEl) sendAmountEl.addEventListener('input', () => {
  const val = parseFloat(sendAmountEl.value) || 0;
  const price = portfolio[selectedCoin].price || 0;
  if (sendAmountFiatEl) sendAmountFiatEl.innerText = `≈ $${(val * price).toFixed(2)}`;

  if (nextBtn) {
    if (val > 0) {
      nextBtn.style.background = '#0a53ff';
      nextBtn.style.color = '#FFFFFF';
      nextBtn.disabled = false;
    } else {
      nextBtn.style.background = '#e5e6eb';
      nextBtn.style.color = '#777';
      nextBtn.disabled = true;
    }
  }
});

/* NEXT -> build confirm screen */
if (nextBtn) nextBtn.addEventListener('click', () => {
  const amt = parseFloat(sendAmountEl.value) || 0;
  const addr = sendAddressEl.value || 'No address';
  const price = portfolio[selectedCoin].price || 0;
  const usd = amt * price;
  const fee = amt * 0.01; // simple fee
  const totalUSD = usd + (fee * price);

  const confirmAmountEl = document.getElementById('confirmAmount');
  const confirmFiatEl = document.getElementById('confirmFiat');
  const confirmFeeEl = document.getElementById('confirmFee');
  const confirmTotalEl = document.getElementById('confirmTotal');
  const confirmToEl = document.getElementById('confirmTo');
  const confirmAssetLabelEl = document.getElementById('confirmAssetLabel');
  const confirmTitleEl = document.getElementById('confirmTitle');

  if (confirmAmountEl) confirmAmountEl.innerText = `-${amt} ${selectedCoin}`;
  if (confirmFiatEl) confirmFiatEl.innerText = `≈ $${usd.toFixed(2)}`;
  if (confirmFeeEl) confirmFeeEl.innerText = `${fee.toFixed(displayConfig[selectedCoin].decimals)} ${selectedCoin}`;
  if (confirmTotalEl) confirmTotalEl.innerText = `$${totalUSD.toFixed(2)}`;
  if (confirmToEl) confirmToEl.innerText = addr;
  if (confirmAssetLabelEl) confirmAssetLabelEl.innerText = `${selectedCoin}`;
  if (confirmTitleEl) confirmTitleEl.innerText = `Transfer ${selectedCoin}`;

  // swap screens
  hideAllPages();
  if (confirmSend) confirmSend.style.display = 'flex';
});

/* back to send from confirm */
if (backToSend) backToSend.addEventListener('click', () => {
  hideAllPages();
  if (sendBTC) sendBTC.style.display = 'flex';
});

/* CONFIRM -> process tx, deduct and show success */
if (confirmBtn) confirmBtn.addEventListener('click', () => {
  // show processing
  hideAllPages();
  if (processingPopup) processingPopup.style.display = 'flex';

  document.body.style.overflow = 'hidden';

  setTimeout(() => {
    // read amount & symbol from confirm display
    const confirmAmtText = (document.getElementById('confirmAmount') && document.getElementById('confirmAmount').innerText) || '';
    const parts = confirmAmtText.replace('-', '').split(' ');
    const amt = parseFloat(parts[0]) || 0;
    const sym = parts[1] || selectedCoin;

    const feeText = (document.getElementById('confirmFee') && document.getElementById('confirmFee').innerText) || '';

    // deduct coin amount
    if (portfolio[sym]) portfolio[sym].amount = Math.max(0, (portfolio[sym].amount || 0) - amt);

    // refresh UI numbers
    updateAllBalances();

    // populate tx details for possible viewing later
    if (txStatus) { txStatus.className = 'status-success'; txStatus.innerText = 'Successful'; }
    if (txAmount) txAmount.innerText = `${amt} ${sym}`;
    if (txFiat) txFiat.innerText = (document.getElementById('confirmFiat') && document.getElementById('confirmFiat').innerText) || '';
    if (txTo) txTo.innerText = (document.getElementById('confirmTo') && document.getElementById('confirmTo').innerText) || '';
    if (txFee) txFee.innerText = feeText || '';
    if (txTotal) txTotal.innerText = (document.getElementById('confirmTotal') && document.getElementById('confirmTotal').innerText) || '';
    if (txTime) txTime.innerText = new Date().toLocaleString();

    // hide processing and show success-screen only (no home overlap)
    if (processingPopup) processingPopup.style.display = 'none';
    showSuccessScreen();
    document.body.style.overflow = '';

  }, 1500);
});

/* processing details -> open tx details as pending */
if (processingDetails) processingDetails.addEventListener('click', () => {
  hideAllPages();
  if (txDetails) txDetails.style.display = 'block';
  document.body.style.overflow = '';
});

/* success screen actions */
if (viewDetailsBtn) viewDetailsBtn.addEventListener('click', () => {
  hideAllPages();
  if (txDetails) txDetails.style.display = 'block';
});
if (successDoneBtn) successDoneBtn.addEventListener('click', () => {
  showMain();
});

/* tx details back / done */
if (txBack) txBack.addEventListener('click', () => {
  showMain();
});
if (txDone) txDone.addEventListener('click', () => {
  showMain();
});

/* ======================================================
   start state: show main dashboard
   ====================================================== */
showMain();
updateAllBalances(); // initial numbers (prices 0 until fetch completes)
</script>
